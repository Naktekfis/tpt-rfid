{% extends "base.html" %}
{% block title %}Live Monitor — CV Benchmark{% endblock %}

{% block content %}
<style>
  /* Full-width layout without base container padding */
  body > div > div.container {
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
</style>

<!-- Main layout -->
<div class="flex gap-4 p-4 pt-6" style="height: calc(100vh - 100px);">

  <!-- Stream panel -->
  <div
    class="flex-1 relative bg-gray-900 rounded-2xl overflow-hidden border border-primary-100 shadow-lg flex items-center justify-center">
    <img id="stream-img" src="{{ url_for('cv.stream_live') }}" class="w-full h-full object-contain"
      onerror="showError()" alt="Live feed">

    <!-- Loading -->
    <div id="stream-placeholder"
      class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-gradient-to-br from-primary-50 via-white to-primary-100">
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-primary-100 border-t-primary-600"></div>
      <p class="text-primary-600 text-sm font-medium">Membuka kamera...</p>
    </div>

    <!-- Error -->
    <div id="stream-error" class="absolute inset-0 hidden flex-col items-center justify-center gap-3 bg-red-50">
      <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
      </svg>
      <p class="text-red-600 text-sm font-semibold">Kamera tidak dapat dibuka</p>
      <p class="text-primary-400 text-xs text-center max-w-[220px]">Pastikan kamera terhubung dan tidak dipakai aplikasi
        lain.</p>
      <button onclick="initCamera()"
        class="mt-1 px-5 py-2 bg-primary-500 hover:bg-primary-600 text-white text-sm font-semibold rounded-lg transition-colors">
        Coba lagi
      </button>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="w-64 flex flex-col gap-3 shrink-0">
    
    <!-- Resolution selector -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Resolusi</p>
      <div id="res-btns" class="flex flex-wrap gap-1 mb-3"></div>
      <div id="res-info" class="text-xs text-primary-600"></div>
    </div>

    <!-- FPS & Resolution Display -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Performa</p>
      <div class="flex items-end gap-1 mb-2">
        <span id="fps-val" class="text-4xl font-extrabold text-violet-600 tabular-nums leading-none">—</span>
        <span class="text-primary-400 text-sm pb-0.5">FPS</span>
      </div>
      <div class="text-xs text-primary-600">
        <span class="text-primary-700 font-semibold">Resolusi aktif:</span>
        <span id="res-val" class="text-primary-900 font-mono font-bold ml-1">—</span>
      </div>
    </div>

    <!-- System Stats -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Sistem</p>
      
      <div class="space-y-3">
        <!-- CPU -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">CPU</span>
            <span id="cpu-val" class="text-primary-900 font-mono font-bold">—%</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="cpu-bar" class="h-full bg-violet-500 rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
          <p id="cpu-warn" class="hidden text-xs text-red-600 font-semibold mt-1">⚠ CPU tinggi</p>
        </div>

        <!-- RAM -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">RAM</span>
            <span id="ram-val" class="text-primary-900 font-mono font-bold">—%</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="ram-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
        </div>

        <!-- Temperature -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">Suhu</span>
            <span id="temp-val" class="text-primary-900 font-mono font-bold">—</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="temp-bar" class="h-full bg-teal-500 rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
          <p id="temp-warn" class="hidden text-xs text-orange-600 font-semibold mt-1">⚠ Suhu tinggi</p>
        </div>
      </div>
    </div>

    <!-- Back Button -->
    <div class="mt-auto">
      <a href="/" class="flex items-center justify-center gap-2 w-full py-3 bg-white hover:bg-primary-50 text-primary-700 border-2 border-primary-200 hover:border-primary-400 font-semibold rounded-xl transition-all text-sm shadow">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Kembali</span>
      </a>
    </div>

  </div>
</div>

<script>
  const RESOLUTION_DIMS = {};
  let statsInterval = null;
  let cameraReady = false;

  // ─── Camera initialization ──────────────────────────────────────────────────

  async function initCamera() {
    showPlaceholder(true); 
    hideError();
    
    try {
      const r = await fetch('/cv/camera/open', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: 0 })
      });
      const d = await r.json();
      
      if (!d.ok) { 
        showError(); 
        return; 
      }
      
      const r2 = await fetch('/cv/resolutions');
      const d2 = await r2.json();
      Object.assign(RESOLUTION_DIMS, d2.dims);
      renderResButtons(d2.available, d2.current);
      cameraReady = true;
      
      console.log('Camera initialized:', d2);
    } catch (e) {
      console.error('Camera init failed:', e);
      showError();
    }
  }

  // ─── Resolution controls ────────────────────────────────────────────────────

  function renderResButtons(available, current) {
    const c = document.getElementById('res-btns');
    if (!c) return;
    
    c.innerHTML = '';
    ['240p', '360p', '480p', '720p', '1080p'].forEach(label => {
      const b = document.createElement('button');
      b.textContent = label;
      b.disabled = !available.includes(label);
      b.className = [
        'px-2.5 py-1 rounded-md text-xs font-mono font-semibold transition-all',
        b.disabled
          ? 'text-primary-300 bg-primary-50 cursor-not-allowed line-through'
          : label === current
            ? 'bg-violet-600 text-white shadow-sm'
            : 'bg-primary-100 text-primary-700 hover:bg-violet-600 hover:text-white cursor-pointer'
      ].join(' ');
      
      if (!b.disabled) {
        b.addEventListener('click', () => setResolution(label));
      }
      c.appendChild(b);
    });
    
    updateResInfo(current);
  }

  async function setResolution(label) {
    try {
      const r = await fetch('/cv/resolution', {
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ resolution: label })
      });
      const d = await r.json();
      
      renderResButtons(d.available || [], d.applied || d.current || label);
      
      if (d.ok) {
        document.getElementById('stream-img').src = '/cv/stream/live?t=' + Date.now();
      }
    } catch (e) {
      console.error('Resolution change failed:', e);
    }
  }

  function updateResInfo(label) {
    const el = document.getElementById('res-info');
    if (!el) return;
    
    const dims = RESOLUTION_DIMS[label];
    el.innerHTML = dims
      ? `<p><span class="text-primary-900 font-mono font-bold">${label}</span></p>
         <p class="mt-0.5">${dims[0]} × ${dims[1]} px</p>`
      : '<p>—</p>';
  }

  // ─── System stats monitoring ────────────────────────────────────────────────

  function startStats() { 
    updateStats(); 
    statsInterval = setInterval(updateStats, 1000); // Update every 1 second
  }

  async function updateStats() {
    try {
      const r = await fetch('/cv/stats?_t=' + Date.now());
      if (!r.ok) throw new Error('Stats fetch failed');
      
      const d = await r.json();
      console.log('Stats received:', d); // DEBUG
      
      // Update FPS
      const fpsEl = document.getElementById('fps-val');
      if (fpsEl) {
        fpsEl.textContent = typeof d.fps === 'number' ? d.fps.toFixed(1) : '—';
        console.log('FPS updated:', fpsEl.textContent);
      } else {
        console.error('fps-val element not found!');
      }
      
      // Update resolution
      const resEl = document.getElementById('res-val');
      if (resEl) {
        resEl.textContent = d.resolution || '—';
        console.log('Resolution updated:', resEl.textContent);
      } else {
        console.error('res-val element not found!');
      }
      
      // Update CPU
      if (typeof d.cpu === 'number') {
        setBar('cpu-bar', 'cpu-val', d.cpu, '%', d.cpu > 90 ? 'bg-red-500' : 'bg-violet-500');
        console.log('CPU updated:', d.cpu);
        const cpuWarn = document.getElementById('cpu-warn');
        if (cpuWarn) cpuWarn.classList.toggle('hidden', d.cpu <= 90);
      }
      
      // Update RAM
      if (typeof d.ram === 'number') {
        setBar('ram-bar', 'ram-val', d.ram, '%', 'bg-blue-500');
        console.log('RAM updated:', d.ram);
      }
      
      // Update Temperature
      const tv = d.temp || 0;
      const tt = tv > 0 ? `${tv.toFixed(1)}°C` : 'N/A';
      const tp = tv > 0 ? Math.min((tv / 80) * 100, 100) : 0;
      const tempColor = tv >= 70 ? 'bg-red-500' : tv >= 60 ? 'bg-orange-500' : 'bg-teal-500';
      setBarRaw('temp-bar', 'temp-val', tp, tt, tempColor);
      console.log('Temperature updated:', tt, 'width:', tp + '%');
      
      const tempWarn = document.getElementById('temp-warn');
      if (tempWarn) tempWarn.classList.toggle('hidden', tv < 70);
      
      // Hide placeholder when camera is ready
      if (d.camera_open) {
        showPlaceholder(false);
      }
      
    } catch (e) {
      console.error('Stats update failed:', e);
    }
  }

  function setBar(barId, valId, percent, unit, colorClass) { 
    setBarRaw(barId, valId, percent, percent.toFixed(1) + unit, colorClass); 
  }

  function setBarRaw(barId, valId, percent, labelText, colorClass) {
    const barEl = document.getElementById(barId);
    const valEl = document.getElementById(valId);
    
    if (barEl) {
      barEl.style.width = Math.min(Math.max(percent, 0), 100) + '%';
      barEl.className = 'h-full rounded-full transition-all duration-500 ' + colorClass;
    }
    
    if (valEl) {
      valEl.textContent = labelText;
    }
  }

  // ─── UI helpers ─────────────────────────────────────────────────────────────

  function showPlaceholder(visible) { 
    const el = document.getElementById('stream-placeholder');
    if (el) el.style.display = visible ? 'flex' : 'none'; 
  }

  function showError() { 
    const errEl = document.getElementById('stream-error');
    if (errEl) errEl.style.display = 'flex'; 
    showPlaceholder(false); 
  }

  function hideError() { 
    const errEl = document.getElementById('stream-error');
    if (errEl) errEl.style.display = 'none'; 
  }

  // ─── Event listeners ────────────────────────────────────────────────────────

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing CV Live page...');
    
    const streamImg = document.getElementById('stream-img');
    if (streamImg) {
      streamImg.addEventListener('load', () => showPlaceholder(false));
    }
    
    // Initialize after DOM is ready
    initCamera(); 
    startStats();
    
    console.log('Initialization complete');
  });

  window.addEventListener('beforeunload', () => { 
    if (statsInterval) clearInterval(statsInterval);
    fetch('/cv/camera/close', { method: 'POST', keepalive: true }); 
  });
</script>
{% endblock %}
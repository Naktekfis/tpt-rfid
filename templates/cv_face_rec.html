{% extends "base.html" %}
{% block title %}Face Recognition ‚Äî CV Benchmark{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-950 flex flex-col">

  <!-- Top bar -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
    <div class="flex items-center gap-3">
      <a href="{{ url_for('cv.cv_index') }}"
         class="text-gray-500 hover:text-white transition-colors text-sm">‚Üê CV Benchmark</a>
      <span class="text-gray-700">/</span>
      <span class="text-white font-semibold text-sm">Face Recognition</span>
    </div>

    <!-- Attempt indicator (hidden until recognition phase) -->
    <div id="attempt-bar" class="hidden items-center gap-3">
      <span class="text-gray-500 text-xs">Percobaan:</span>
      <div class="flex gap-1">
        <span id="dot-1" class="w-2.5 h-2.5 rounded-full bg-violet-600"></span>
        <span id="dot-2" class="w-2.5 h-2.5 rounded-full bg-gray-700"></span>
        <span id="dot-3" class="w-2.5 h-2.5 rounded-full bg-gray-700"></span>
      </div>
      <span id="threshold-label" class="text-xs text-gray-500 font-mono">threshold: 0.50</span>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 1: Capture phase ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="phase-capture" class="flex flex-1 flex-col items-center justify-center gap-8 p-6">

    <!-- Camera preview for capture -->
    <div class="relative w-full max-w-2xl aspect-video bg-black rounded-2xl overflow-hidden border border-gray-800">
      <img id="capture-stream" src="{{ url_for('cv.stream_live') }}"
           class="w-full h-full object-cover"
           alt="Preview kamera">

      <!-- Placeholder -->
      <div id="capture-placeholder"
           class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-gray-950">
        <div class="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-500 text-sm">Membuka kamera‚Ä¶</p>
      </div>

      <!-- Face guide overlay (crosshair) -->
      <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
        <div class="w-48 h-56 border-2 border-emerald-400/60 rounded-full"></div>
      </div>

      <!-- FPS corner -->
      <div id="capture-fps" class="absolute top-3 left-3 bg-black/60 text-emerald-400 text-xs font-mono px-2 py-1 rounded hidden">
        ‚Äî FPS
      </div>
    </div>

    <!-- Instructions + capture button -->
    <div class="text-center space-y-3">
      <p class="text-gray-400 text-sm">Posisikan wajah di dalam lingkaran panduan, lalu tekan tombol.</p>
      <button id="btn-capture"
              onclick="captureReference()"
              class="px-8 py-3 bg-emerald-600 hover:bg-emerald-500 active:scale-95 disabled:opacity-40
                     disabled:cursor-not-allowed text-white font-semibold rounded-xl
                     transition-all duration-150 text-base">
        üì∏ Ambil Foto Referensi
      </button>
      <p id="capture-msg" class="text-red-400 text-sm hidden">‚Äî</p>
    </div>

  </div>

  <!-- ‚ïê‚ïê STEP 2: Recognition phase ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="phase-recognition" class="hidden flex-1 flex gap-4 p-6">

    <!-- Stream -->
    <div class="flex-1 relative bg-black rounded-2xl overflow-hidden border border-gray-800 flex items-center justify-center">
      <img id="rec-stream" src=""   {# set dynamically #}
           class="w-full h-full object-contain"
           alt="Live recognition">

      <!-- Match result overlay ‚Äî flashes on match/no-match -->
      <div id="result-overlay"
           class="absolute inset-0 hidden items-center justify-center pointer-events-none">
        <div id="result-badge"
             class="px-8 py-4 rounded-2xl text-2xl font-bold shadow-2xl text-white">
          ‚Äî
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="w-60 flex flex-col gap-3">

      <!-- Resolution selector -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-gray-500 text-xs uppercase tracking-widest mb-3">Resolusi Live</p>
        <div id="rec-res-btns" class="flex flex-wrap gap-1">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- FPS + Recognition stats -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-3">
        <p class="text-gray-500 text-xs uppercase tracking-widest">Performa</p>
        <div class="flex items-end gap-1">
          <span id="rec-fps" class="text-4xl font-bold text-emerald-400 tabular-nums">‚Äî</span>
          <span class="text-gray-500 text-sm mb-1">FPS</span>
        </div>
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-gray-400">Kemiripan</span>
            <span id="sim-val" class="text-white font-mono">‚Äî%</span>
          </div>
          <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
            <div id="sim-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
        </div>
        <div class="flex items-center justify-between text-xs">
          <span class="text-gray-400">Threshold saat ini</span>
          <span id="rec-threshold" class="text-violet-400 font-mono">‚Äî</span>
        </div>
        <div class="flex items-center gap-2 pt-1">
          <span class="text-gray-400 text-xs">Status:</span>
          <span id="match-badge"
                class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-800 text-gray-500">
            Scanning‚Ä¶
          </span>
        </div>
      </div>

      <!-- System load -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-3">
        <p class="text-gray-500 text-xs uppercase tracking-widest">Load Sistem</p>

        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-gray-400">CPU</span>
            <span id="r-cpu-val" class="text-white font-mono">‚Äî%</span>
          </div>
          <div class="h-1.5 bg-gray-800 rounded-full">
            <div id="r-cpu-bar" class="h-full bg-violet-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-gray-400">RAM</span>
            <span id="r-ram-val" class="text-white font-mono">‚Äî%</span>
          </div>
          <div class="h-1.5 bg-gray-800 rounded-full">
            <div id="r-ram-bar" class="h-full bg-blue-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-gray-400">Suhu</span>
            <span id="r-temp-val" class="text-white font-mono">‚Äî¬∞C</span>
          </div>
          <div class="h-1.5 bg-gray-800 rounded-full">
            <div id="r-temp-bar" class="h-full bg-orange-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col gap-2 mt-auto">
        <button id="btn-retry" onclick="retryRecognition()"
                class="w-full py-2.5 bg-yellow-600/20 hover:bg-yellow-600/40 border border-yellow-600/40
                       text-yellow-400 text-sm font-semibold rounded-xl transition-all hidden">
          üîÑ Retry (threshold lebih longgar)
        </button>
        <button onclick="resetToCapture()"
                class="w-full py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm
                       rounded-xl transition-all">
          ‚Ü© Ambil Foto Baru
        </button>
      </div>

    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let phase = 'capture';          // 'capture' | 'recognition'
let statsInterval = null;
let matchLoopInterval = null;
let currentAttempt = 1;
let consecutiveMatches = 0;
const MATCH_FRAMES_NEEDED = 3;  // must match N consecutive frames to confirm

// ‚îÄ‚îÄ Phase management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function initCamera() {
  const res = await fetch('/cv/camera/open', { method: 'POST' });
  const d = await res.json();
  if (d.ok) {
    document.getElementById('capture-placeholder').style.display = 'none';
    startCaptureStats();
  }
}

function showPhase(p) {
  phase = p;
  document.getElementById('phase-capture').style.display     = p === 'capture'     ? 'flex' : 'none';
  document.getElementById('phase-recognition').style.display = p === 'recognition' ? 'flex' : 'none';
  document.getElementById('attempt-bar').classList.toggle('hidden', p !== 'recognition');
}

// ‚îÄ‚îÄ Capture ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function captureReference() {
  const btn = document.getElementById('btn-capture');
  const msg = document.getElementById('capture-msg');

  btn.disabled = true;
  btn.textContent = '‚è≥ Mengambil foto‚Ä¶';
  msg.classList.add('hidden');

  const res = await fetch('/cv/capture', { method: 'POST' });
  const d = await res.json();

  if (d.ok) {
    enterRecognitionPhase();
  } else {
    msg.textContent = '‚ö† ' + d.message;
    msg.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'üì∏ Ambil Foto Referensi';
  }
}

// ‚îÄ‚îÄ Recognition phase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function enterRecognitionPhase() {
  // Load resolutions
  const resRes = await fetch('/cv/resolutions');
  const resData = await resRes.json();
  renderRecResButtons(resData.available, resData.current);

  // Start stream
  const img = document.getElementById('rec-stream');
  img.src = '/cv/stream/recognition?t=' + Date.now();

  showPhase('recognition');
  clearInterval(statsInterval);
  startRecStats();
  startMatchLoop();
  updateAttemptUI(1, 0.50);
}

// ‚îÄ‚îÄ Match polling loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We poll /cv/stats every 800ms. The server does the recognition per-frame.
// Client accumulates N consecutive positives before declaring COCOK.

function startMatchLoop() {
  consecutiveMatches = 0;
  clearInterval(matchLoopInterval);
  matchLoopInterval = setInterval(checkMatch, 800);
}

let lastMatchPoll = null;

async function checkMatch() {
  try {
    const res = await fetch('/cv/stats');
    const d = await res.json();
    if (!d.has_reference) return;

    updateRecStats(d);

    if (d.last_match) {
      consecutiveMatches++;
      if (consecutiveMatches >= MATCH_FRAMES_NEEDED) {
        clearInterval(matchLoopInterval);
        showMatchResult(true, d.last_similarity);
      }
    } else {
      consecutiveMatches = 0;
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ Retry logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let noMatchTimeout = null;

function scheduleRetryPrompt() {
  // After 8 seconds of no confirmed match, show retry button
  clearTimeout(noMatchTimeout);
  noMatchTimeout = setTimeout(() => {
    if (phase === 'recognition' && currentAttempt <= 3) {
      document.getElementById('btn-retry').classList.remove('hidden');
    }
  }, 8000);
}

async function retryRecognition() {
  if (currentAttempt >= 3) {
    // Max retries reached, force final check
    return;
  }
  const res = await fetch('/cv/retry', { method: 'POST' });
  const d = await res.json();
  currentAttempt = d.attempt;
  consecutiveMatches = 0;

  updateAttemptUI(d.attempt, d.threshold);
  document.getElementById('btn-retry').classList.add('hidden');
  document.getElementById('match-badge').textContent = 'Scanning‚Ä¶';
  document.getElementById('match-badge').className =
    'text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-800 text-gray-500';

  if (currentAttempt >= 3) {
    // Last attempt: disable retry button permanently
    document.getElementById('btn-retry').disabled = true;
    document.getElementById('btn-retry').textContent = '(Percobaan terakhir)';
    document.getElementById('btn-retry').classList.remove('hidden');
  }

  clearInterval(matchLoopInterval);
  startMatchLoop();
  scheduleRetryPrompt();
}

function showMatchResult(matched, similarity) {
  clearTimeout(noMatchTimeout);
  document.getElementById('btn-retry').classList.add('hidden');

  const overlay = document.getElementById('result-overlay');
  const badge   = document.getElementById('result-badge');

  if (matched) {
    badge.className = 'px-8 py-4 rounded-2xl text-2xl font-bold shadow-2xl text-white bg-emerald-600/90';
    badge.textContent = `‚úì COCOK  ${(similarity*100).toFixed(0)}%`;
    document.getElementById('match-badge').textContent = 'COCOK';
    document.getElementById('match-badge').className =
      'text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-900 text-emerald-400';
  } else {
    badge.className = 'px-8 py-4 rounded-2xl text-2xl font-bold shadow-2xl text-white bg-red-700/90';
    badge.textContent = '‚úó TIDAK COCOK';
    document.getElementById('match-badge').textContent = 'TIDAK COCOK';
    document.getElementById('match-badge').className =
      'text-xs font-semibold px-2 py-0.5 rounded-full bg-red-900 text-red-400';
  }

  overlay.style.display = 'flex';
  setTimeout(() => overlay.style.display = 'none', 2500);
}

// ‚îÄ‚îÄ Attempt UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateAttemptUI(attempt, threshold) {
  currentAttempt = attempt;
  [1, 2, 3].forEach(i => {
    const dot = document.getElementById('dot-' + i);
    dot.className = i <= attempt
      ? 'w-2.5 h-2.5 rounded-full bg-violet-500'
      : 'w-2.5 h-2.5 rounded-full bg-gray-700';
  });
  document.getElementById('threshold-label').textContent = `threshold: ${threshold.toFixed(2)}`;
  document.getElementById('rec-threshold').textContent = threshold.toFixed(2);
}

// ‚îÄ‚îÄ Resolution buttons (recognition phase) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderRecResButtons(available, current) {
  const container = document.getElementById('rec-res-btns');
  container.innerHTML = '';
  ['240p','360p','480p','720p','1080p'].forEach(label => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.className = [
      'px-2 py-1 rounded text-xs font-mono transition-all',
      available.includes(label)
        ? 'text-white bg-gray-800 hover:bg-emerald-700'
        : 'text-gray-700 bg-gray-900 cursor-not-allowed opacity-40 line-through'
    ].join(' ');
    if (label === current) btn.classList.add('!bg-emerald-700', 'text-white');
    if (!available.includes(label)) btn.disabled = true;
    btn.addEventListener('click', async () => {
      const res = await fetch('/cv/resolution', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ resolution: label })
      });
      const d = await res.json();
      if (d.ok) {
        renderRecResButtons(d.available, d.applied);
        // Force stream reconnect
        const img = document.getElementById('rec-stream');
        img.src = '/cv/stream/recognition?t=' + Date.now();
      }
    });
    container.appendChild(btn);
  });
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startCaptureStats() {
  statsInterval = setInterval(async () => {
    try {
      const res = await fetch('/cv/stats');
      const d = await res.json();
      const el = document.getElementById('capture-fps');
      el.textContent = d.fps.toFixed(1) + ' FPS';
      el.classList.remove('hidden');
    } catch(e) {}
  }, 1000);
}

function startRecStats() {
  statsInterval = setInterval(updateRecStats, 1200);
  scheduleRetryPrompt();
}

function updateRecStats(d_override) {
  async function _update(d) {
    document.getElementById('rec-fps').textContent = d.fps.toFixed(1);

    const sim = d.last_similarity;
    document.getElementById('sim-val').textContent = sim.toFixed(1) + '%';
    const simBar = document.getElementById('sim-bar');
    simBar.style.width = sim + '%';
    simBar.className = `h-full rounded-full transition-all duration-300 ${
      sim >= 70 ? 'bg-emerald-500' : sim >= 50 ? 'bg-yellow-500' : 'bg-red-500'
    }`;

    // System
    setBar2('r-cpu-bar','r-cpu-val', d.cpu,'%', d.cpu>90?'bg-red-500':'bg-violet-500');
    setBar2('r-ram-bar','r-ram-val', d.ram,'%','bg-blue-500');
    const tempPct = Math.min((d.temp/80)*100,100);
    setBar2raw('r-temp-bar','r-temp-val', tempPct, d.temp+'¬∞C',
               d.temp>=70?'bg-red-500':d.temp>=60?'bg-orange-500':'bg-teal-500');
  }

  if (d_override) { _update(d_override); return; }
  fetch('/cv/stats').then(r => r.json()).then(_update).catch(()=>{});
}

function setBar2(barId, valId, pct, unit, cls) {
  setBar2raw(barId, valId, pct, pct.toFixed(1)+unit, cls);
}
function setBar2raw(barId, valId, pct, label, cls) {
  document.getElementById(barId).style.width = Math.min(pct,100)+'%';
  document.getElementById(barId).className = `h-full rounded-full transition-all ${cls}`;
  document.getElementById(valId).textContent = label;
}

// ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function resetToCapture() {
  clearInterval(matchLoopInterval);
  clearInterval(statsInterval);
  clearTimeout(noMatchTimeout);

  await fetch('/cv/reset', { method: 'POST' });

  // Restart capture stream
  document.getElementById('capture-stream').src = '/cv/stream/live?t=' + Date.now();
  document.getElementById('capture-placeholder').style.display = 'none';
  document.getElementById('capture-msg').classList.add('hidden');
  document.getElementById('btn-capture').disabled = false;
  document.getElementById('btn-capture').textContent = 'üì∏ Ambil Foto Referensi';
  document.getElementById('btn-retry').classList.add('hidden');
  document.getElementById('btn-retry').disabled = false;

  currentAttempt = 1;
  consecutiveMatches = 0;
  showPhase('capture');
  startCaptureStats();
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
showPhase('capture');
initCamera();

window.addEventListener('beforeunload', () => {
  fetch('/cv/reset',        { method: 'POST', keepalive: true });
  fetch('/cv/camera/close', { method: 'POST', keepalive: true });
});
</script>
{% endblock %}

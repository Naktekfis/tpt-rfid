{% extends "base.html" %}
{% block title %}Face Recognition ‚Äî CV Benchmark{% endblock %}

{% block content %}
<style>
  /* Full-width layout without base container padding */
  body > div > div.container {
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
</style>

<!-- ‚ïê‚ïê CAPTURE PHASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="phase-capture" class="flex gap-4 p-4 pt-6" style="height: calc(100vh - 100px);">

  <!-- Stream panel (same style as Live Monitor) -->
  <div
    class="flex-1 relative bg-gray-900 rounded-2xl overflow-hidden border border-primary-100 shadow-lg flex items-center justify-center">
    <img id="capture-stream" src="{{ url_for('cv.stream_live') }}" class="w-full h-full object-cover"
      alt="Preview kamera">

    <!-- Loading -->
    <div id="capture-placeholder"
      class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-gradient-to-br from-primary-50 via-white to-primary-100">
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-primary-100 border-t-emerald-500"></div>
      <p class="text-primary-600 text-sm font-medium">Membuka kamera...</p>
    </div>

    <!-- Face guide overlay -->
    <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
      <div class="w-48 h-56 border-2 border-emerald-400/60 rounded-full"
        style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.2);"></div>
    </div>

    <!-- FPS badge -->
    <div id="capture-fps"
      class="absolute top-3 left-3 bg-black/60 text-emerald-400 text-xs font-mono px-2 py-1 rounded hidden">‚Äî FPS</div>
  </div>

  <!-- Sidebar (capture) -->
  <div class="w-56 flex flex-col gap-3 shrink-0">

    <!-- Instructions card -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-5">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Panduan</p>
      <div class="space-y-3">
        <div class="flex items-start gap-2.5">
          <span class="text-emerald-500 text-lg shrink-0">1Ô∏è‚É£</span>
          <p class="text-xs text-primary-700 leading-relaxed">Posisikan wajah Anda dalam oval guide</p>
        </div>
        <div class="flex items-start gap-2.5">
          <span class="text-emerald-500 text-lg shrink-0">2Ô∏è‚É£</span>
          <p class="text-xs text-primary-700 leading-relaxed">Pastikan pencahayaan cukup</p>
        </div>
        <div class="flex items-start gap-2.5">
          <span class="text-emerald-500 text-lg shrink-0">3Ô∏è‚É£</span>
          <p class="text-xs text-primary-700 leading-relaxed">Klik tombol untuk capture</p>
        </div>
      </div>
    </div>

    <!-- Capture button -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <button id="btn-capture" onclick="captureReference()"
        class="w-full py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 active:scale-[0.97] disabled:opacity-40 disabled:cursor-not-allowed text-white font-bold rounded-xl transition-all text-sm shadow-lg">
        üì∏ Ambil Foto Referensi
      </button>
      <p id="capture-msg" class="hidden mt-2 text-red-500 text-xs text-center font-medium">‚Äî</p>
    </div>

    <!-- Back Button -->
    <div class="mt-auto">
      <a href="/" class="flex items-center justify-center gap-2 w-full py-3 bg-white hover:bg-primary-50 text-primary-700 border-2 border-primary-200 hover:border-primary-400 font-semibold rounded-xl transition-all text-sm shadow">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Kembali</span>
      </a>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê RECOGNITION PHASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="phase-recognition" class="hidden gap-4 p-4 pt-6" style="height: calc(100vh - 100px);">

  <!-- Stream panel -->
  <div
    class="flex-1 relative bg-gray-900 rounded-2xl overflow-hidden border border-primary-100 shadow-lg flex items-center justify-center">
    <img id="rec-stream" src="" class="w-full h-full object-contain" alt="Live recognition">

    <!-- Match result overlay -->
    <div id="result-overlay" class="absolute inset-0 hidden items-center justify-center pointer-events-none">
      <div id="result-badge" class="px-8 py-4 rounded-2xl text-2xl font-extrabold text-white shadow-2xl">‚Äî</div>
    </div>

    <!-- Attempt indicator (top-right) -->
    <div id="attempt-bar" class="hidden absolute top-3 right-3 bg-black/70 backdrop-blur-sm px-3 py-2 rounded-lg">
      <div class="flex items-center gap-2">
        <span class="text-white text-xs font-semibold">Percobaan:</span>
        <div class="flex gap-1">
          <div id="dot-1" class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
          <div id="dot-2" class="w-2.5 h-2.5 rounded-full bg-primary-200"></div>
          <div id="dot-3" class="w-2.5 h-2.5 rounded-full bg-primary-200"></div>
        </div>
      </div>
      <p id="threshold-label" class="text-emerald-400 text-xs font-mono font-bold mt-0.5">threshold: 0.50</p>
    </div>
  </div>

  <!-- Sidebar (recognition) -->
  <div class="w-56 flex flex-col gap-3 shrink-0">

    <!-- Resolution selector -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Resolusi Live</p>
      <div id="rec-res-btns" class="flex flex-wrap gap-1"></div>
    </div>

    <!-- FPS + Similarity -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Performa</p>
      <div class="flex items-end gap-1 mb-3">
        <span id="rec-fps" class="text-4xl font-extrabold text-emerald-600 tabular-nums leading-none">‚Äî</span>
        <span class="text-primary-400 text-sm pb-0.5">FPS</span>
      </div>

      <!-- Similarity bar -->
      <div class="mb-2">
        <div class="flex justify-between text-xs mb-1">
          <span class="text-primary-700 font-semibold">Kemiripan</span>
          <span id="sim-val" class="text-primary-900 font-mono font-bold">‚Äî%</span>
        </div>
        <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
          <div id="sim-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-300" style="width:0%">
          </div>
        </div>
      </div>

      <div class="flex justify-between text-xs mb-2">
        <span class="text-primary-700 font-semibold">Threshold</span>
        <span id="rec-threshold" class="text-violet-600 font-mono font-bold">‚Äî</span>
      </div>

      <div class="flex items-center gap-2">
        <span class="text-xs text-primary-700 font-semibold">Status:</span>
        <span id="match-badge"
          class="text-xs font-bold px-2.5 py-0.5 rounded-full bg-primary-100 text-primary-500">Scanning‚Ä¶</span>
      </div>
    </div>

    <!-- System load -->
    <div class="bg-white rounded-2xl border border-primary-100 shadow p-4">
      <p class="text-xs font-bold text-primary-400 uppercase tracking-widest mb-3">Load Sistem</p>
      <div class="space-y-2.5">
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">CPU</span>
            <span id="r-cpu-val" class="text-primary-900 font-mono font-bold">‚Äî%</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="r-cpu-bar" class="h-full bg-violet-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">RAM</span>
            <span id="r-ram-val" class="text-primary-900 font-mono font-bold">‚Äî%</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="r-ram-bar" class="h-full bg-blue-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-primary-700 font-semibold">Suhu</span>
            <span id="r-temp-val" class="text-primary-900 font-mono font-bold">‚Äî¬∞C</span>
          </div>
          <div class="h-1.5 bg-primary-100 rounded-full overflow-hidden">
            <div id="r-temp-bar" class="h-full bg-orange-500 rounded-full transition-all" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-col gap-2">
      <button id="btn-retry" onclick="retryRecognition()"
        class="hidden w-full py-2.5 bg-amber-50 hover:bg-amber-100 border border-amber-300 text-amber-700 text-sm font-bold rounded-xl transition-all">
        üîÑ Retry (threshold lebih longgar)
      </button>
      <button onclick="resetToCapture()"
        class="w-full py-2.5 bg-primary-100 hover:bg-primary-200 text-primary-700 text-sm font-semibold rounded-xl transition-all">
        ‚Ü© Ambil Foto Baru
      </button>
    </div>

    <!-- Back Button -->
    <div class="mt-auto pt-2">
      <a href="/" class="flex items-center justify-center gap-2 w-full py-3 bg-white hover:bg-primary-50 text-primary-700 border-2 border-primary-200 hover:border-primary-400 font-semibold rounded-xl transition-all text-sm shadow">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Kembali</span>
      </a>
    </div>

  </div>
</div>

<script>
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let phase = 'capture';
  let statsInterval = null;
  let matchLoopInterval = null;
  let currentAttempt = 1;
  let consecutiveMatches = 0;
  const MATCH_FRAMES_NEEDED = 3;

  // ‚îÄ‚îÄ Phase management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function initCamera() {
    const r = await fetch('/cv/camera/open', { method: 'POST' });
    const d = await r.json();
    if (d.ok) {
      document.getElementById('capture-placeholder').style.display = 'none';
      startCaptureStats();
    }
  }

  function showPhase(p) {
    phase = p;
    document.getElementById('phase-capture').style.display = p === 'capture' ? 'flex' : 'none';
    document.getElementById('phase-recognition').style.display = p === 'recognition' ? 'flex' : 'none';
    document.getElementById('attempt-bar').classList.toggle('hidden', p !== 'recognition');
    if (p === 'recognition') document.getElementById('attempt-bar').classList.add('flex');
  }

  // ‚îÄ‚îÄ Capture ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function captureReference() {
    const btn = document.getElementById('btn-capture');
    const msg = document.getElementById('capture-msg');
    btn.disabled = true;
    btn.textContent = 'Mengambil foto...';
    msg.classList.add('hidden');

    const r = await fetch('/cv/capture', { method: 'POST' });
    const d = await r.json();

    if (d.ok) {
      enterRecognitionPhase();
    } else {
      msg.textContent = d.message;
      msg.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'üì∏ Ambil Foto Referensi';
    }
  }

  // ‚îÄ‚îÄ Recognition phase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function enterRecognitionPhase() {
    const r = await fetch('/cv/resolutions');
    const d = await r.json();
    renderRecResButtons(d.available, d.current);

    document.getElementById('rec-stream').src = '/cv/stream/recognition?t=' + Date.now();
    showPhase('recognition');
    clearInterval(statsInterval);
    startRecStats();
    startMatchLoop();
    updateAttemptUI(1, 0.50);
  }

  // ‚îÄ‚îÄ Match polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function startMatchLoop() {
    consecutiveMatches = 0;
    clearInterval(matchLoopInterval);
    matchLoopInterval = setInterval(checkMatch, 800);
  }

  async function checkMatch() {
    try {
      const r = await fetch('/cv/stats');
      const d = await r.json();
      if (!d.has_reference) return;
      updateRecStats(d);
      if (d.last_match) {
        consecutiveMatches++;
        if (consecutiveMatches >= MATCH_FRAMES_NEEDED) {
          clearInterval(matchLoopInterval);
          showMatchResult(true, d.last_similarity);
        }
      } else { consecutiveMatches = 0; }
    } catch (e) { }
  }

  // ‚îÄ‚îÄ Retry logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let noMatchTimeout = null;

  function scheduleRetryPrompt() {
    clearTimeout(noMatchTimeout);
    noMatchTimeout = setTimeout(() => {
      if (phase === 'recognition' && currentAttempt <= 3) {
        document.getElementById('btn-retry').classList.remove('hidden');
      }
    }, 8000);
  }

  async function retryRecognition() {
    if (currentAttempt >= 3) return;
    const r = await fetch('/cv/retry', { method: 'POST' });
    const d = await r.json();
    currentAttempt = d.attempt;
    consecutiveMatches = 0;

    updateAttemptUI(d.attempt, d.threshold);
    document.getElementById('btn-retry').classList.add('hidden');
    document.getElementById('match-badge').textContent = 'Scanning‚Ä¶';
    document.getElementById('match-badge').className = 'text-xs font-bold px-2.5 py-0.5 rounded-full bg-primary-100 text-primary-500';

    if (currentAttempt >= 3) {
      document.getElementById('btn-retry').disabled = true;
      document.getElementById('btn-retry').textContent = '(Percobaan terakhir)';
      document.getElementById('btn-retry').classList.remove('hidden');
    }

    clearInterval(matchLoopInterval);
    startMatchLoop();
    scheduleRetryPrompt();
  }

  function showMatchResult(matched, similarity) {
    clearTimeout(noMatchTimeout);
    document.getElementById('btn-retry').classList.add('hidden');
    const overlay = document.getElementById('result-overlay');
    const badge = document.getElementById('result-badge');
    const chip = document.getElementById('match-badge');

    if (matched) {
      badge.className = 'px-8 py-4 rounded-2xl text-2xl font-extrabold text-white shadow-2xl bg-emerald-500';
      badge.textContent = `MATCH  ${(similarity * 100).toFixed(0)}%`;
      chip.textContent = 'MATCH ‚úì';
      chip.className = 'text-xs font-bold px-2.5 py-0.5 rounded-full bg-emerald-100 text-emerald-600';
    } else {
      badge.className = 'px-8 py-4 rounded-2xl text-2xl font-extrabold text-white shadow-2xl bg-red-500';
      badge.textContent = 'NO MATCH';
      chip.textContent = 'NO MATCH';
      chip.className = 'text-xs font-bold px-2.5 py-0.5 rounded-full bg-red-100 text-red-600';
    }
    overlay.style.display = 'flex';
    setTimeout(() => overlay.style.display = 'none', 2500);
  }

  // ‚îÄ‚îÄ Attempt UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function updateAttemptUI(attempt, threshold) {
    currentAttempt = attempt;
    [1, 2, 3].forEach(i => {
      document.getElementById('dot-' + i).className =
        'w-2.5 h-2.5 rounded-full ' + (i <= attempt ? 'bg-emerald-500' : 'bg-primary-200');
    });
    document.getElementById('threshold-label').textContent = `threshold: ${threshold.toFixed(2)}`;
    document.getElementById('rec-threshold').textContent = threshold.toFixed(2);
  }

  // ‚îÄ‚îÄ Resolution buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function renderRecResButtons(available, current) {
    const c = document.getElementById('rec-res-btns');
    c.innerHTML = '';
    ['240p', '360p', '480p', '720p', '1080p'].forEach(label => {
      const b = document.createElement('button');
      b.textContent = label;
      b.disabled = !available.includes(label);
      b.className = [
        'px-2.5 py-1 rounded-md text-xs font-mono font-semibold transition-all',
        b.disabled
          ? 'text-primary-300 bg-primary-50 cursor-not-allowed line-through'
          : label === current
            ? 'bg-emerald-600 text-white shadow-sm'
            : 'bg-primary-100 text-primary-700 hover:bg-emerald-600 hover:text-white cursor-pointer'
      ].join(' ');
      b.addEventListener('click', () => setRecResolution(label));
      c.appendChild(b);
    });
  }

  async function setRecResolution(label) {
    const r = await fetch('/cv/resolution', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ resolution: label })
    });
    const d = await r.json();
    renderRecResButtons(d.available || [], d.applied || d.current || label);
    if (d.ok) document.getElementById('rec-stream').src = '/cv/stream/recognition?t=' + Date.now();
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function startCaptureStats() {
    statsInterval = setInterval(async () => {
      try {
        const r = await fetch('/cv/stats'); const d = await r.json();
        const el = document.getElementById('capture-fps');
        el.textContent = d.fps.toFixed(1) + ' FPS';
        el.classList.remove('hidden');
      } catch (e) { }
    }, 1000);
  }

  function startRecStats() {
    statsInterval = setInterval(updateRecStats, 1200);
    scheduleRetryPrompt();
  }

  function updateRecStats(d_override) {
    function _update(d) {
      document.getElementById('rec-fps').textContent = d.fps.toFixed(1);
      const sim = d.last_similarity;
      document.getElementById('sim-val').textContent = sim.toFixed(1) + '%';
      const sb = document.getElementById('sim-bar');
      sb.style.width = sim + '%';
      sb.className = 'h-full rounded-full transition-all duration-300 ' +
        (sim >= 70 ? 'bg-emerald-500' : sim >= 50 ? 'bg-yellow-500' : 'bg-red-500');

      setBar('r-cpu-bar', 'r-cpu-val', d.cpu, '%', d.cpu > 90 ? 'bg-red-500' : 'bg-violet-500');
      setBar('r-ram-bar', 'r-ram-val', d.ram, '%', 'bg-blue-500');
      const tp = Math.min((d.temp / 80) * 100, 100);
      setBarRaw('r-temp-bar', 'r-temp-val', tp, d.temp + '¬∞C', d.temp >= 70 ? 'bg-red-500' : d.temp >= 60 ? 'bg-orange-500' : 'bg-teal-500');
    }
    if (d_override) { _update(d_override); return; }
    fetch('/cv/stats').then(r => r.json()).then(_update).catch(() => { });
  }

  function setBar(b, v, p, u, c) { setBarRaw(b, v, p, p.toFixed(1) + u, c); }
  function setBarRaw(b, v, p, l, c) {
    const el = document.getElementById(b);
    el.style.width = Math.min(p, 100) + '%';
    el.className = 'h-full rounded-full transition-all ' + c;
    document.getElementById(v).textContent = l;
  }

  // ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function resetToCapture() {
    clearInterval(matchLoopInterval);
    clearInterval(statsInterval);
    clearTimeout(noMatchTimeout);
    await fetch('/cv/reset', { method: 'POST' });

    document.getElementById('capture-stream').src = '/cv/stream/live?t=' + Date.now();
    document.getElementById('capture-placeholder').style.display = 'none';
    document.getElementById('capture-msg').classList.add('hidden');
    document.getElementById('btn-capture').disabled = false;
    document.getElementById('btn-capture').textContent = 'üì∏ Ambil Foto Referensi';
    document.getElementById('btn-retry').classList.add('hidden');
    document.getElementById('btn-retry').disabled = false;
    currentAttempt = 1;
    consecutiveMatches = 0;
    showPhase('capture');
    startCaptureStats();
  }

  // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showPhase('capture');
  initCamera();
  window.addEventListener('beforeunload', () => {
    fetch('/cv/reset', { method: 'POST', keepalive: true });
    fetch('/cv/camera/close', { method: 'POST', keepalive: true });
  });
</script>
{% endblock %}